<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F-Lambda Neural OS | آمن ومعزول</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+Arabic:wght@300;600&display=swap');
        body { font-family: 'Space Grotesk', 'Noto Sans Arabic', sans-serif; background-color: #020617; color: white; margin: 0; overflow: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.05); }
        .spectrum-id { font-family: monospace; color: #4ade80; }
        .chat-bubble-ai { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(99, 102, 241, 0.2); }
        .chat-bubble-user { background: #4f46e5; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e1b4b; border-radius: 10px; }
        .api-modal { background: rgba(2, 6, 23, 0.95); backdrop-filter: blur(20px); z-index: 100; }
    </style>
</head>
<body class="h-screen text-right">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [apiKey, setApiKey] = useState(localStorage.getItem('f_lambda_key') || '');
            const [showKeyModal, setShowKeyModal] = useState(!localStorage.getItem('f_lambda_key'));
            const [spectrumID, setSpectrumID] = useState(null);
            const [partialData, setPartialData] = useState(null);
            const [messages, setMessages] = useState([
                { id: 1, role: 'ai', text: 'نظام F-Lambda نشط. يرجى التأكد من إدخال مفتاح API الخاص بكِ في الإعدادات لبدء المعالجة الإدراكية.' }
            ]);
            const [chatInput, setChatInput] = useState('');
            const [status, setStatus] = useState("IDLE");
            const [feedbackLoop, setFeedbackLoop] = useState([]);
            
            const messagesEndRef = useRef(null);
            const F_CONSTANT = 15.0725;

            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const saveApiKey = (key) => {
                localStorage.setItem('f_lambda_key', key);
                setApiKey(key);
                setShowKeyModal(false);
            };

            const handleFileUpload = async (file) => {
                setStatus("PROCESSING");
                const id = `SPEC-${Math.random().toString(16).slice(2, 8).toUpperCase()}-${F_CONSTANT}`;
                setSpectrumID(id);
                setPartialData({ name: file.name, type: file.type, size: `${(file.size / 1024).toFixed(2)} KB` });
                setMessages(prev => [...prev, { id: Date.now(), role: 'ai', text: `تم توليد الهوية الفيزيائية للملف: ${id}` }]);
                setFeedbackLoop(prev => [{id: Date.now(), text: `معالجة: ${file.name}`, parent: id}, ...prev]);
                setStatus("IDLE");
            };

            const handleSendMessage = async () => {
                if (!chatInput.trim() || !apiKey) return;

                const userMsg = { id: Date.now(), role: 'user', text: chatInput };
                setMessages(prev => [...prev, userMsg]);
                setChatInput('');
                setStatus("COGNITION");

                try {
                    const prompt = `أنت واجهة إدراك لنظام F-Lambda. الثابت: ${F_CONSTANT}. الهوية: ${spectrumID || 'لا يوجد'}. المستخدم يسأل: ${chatInput}`;
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });

                    const data = await response.json();
                    if (data.error) throw new Error(data.error.message);
                    setMessages(prev => [...prev, { id: Date.now() + 1, role: 'ai', text: data.candidates[0].content.parts[0].text }]);
                } catch (err) {
                    setMessages(prev => [...prev, { id: Date.now() + 1, role: 'ai', text: "خطأ: تأكدي من صحة مفتاح API." }]);
                } finally { setStatus("IDLE"); }
            };

            return (
                <div className="flex h-full w-full bg-black relative">
                    {/* نافذة طلب المفتاح - تظهر مرة واحدة فقط */}
                    {showKeyModal && (
                        <div className="absolute inset-0 api-modal flex items-center justify-center p-6 text-center">
                            <div className="max-w-md w-full p-8 border border-white/10 rounded-[2rem] bg-slate-900">
                                <h2 className="text-xl font-bold mb-4 text-indigo-400">تفعيل النظام الإدراكي</h2>
                                <p className="text-xs text-slate-400 mb-6 leading-relaxed">لحماية خصوصيتك، يرجى إدخال مفتاح Gemini API الخاص بكِ. سيتم حفظه محلياً في متصفحك فقط ولن يتم رفعه على GitHub.</p>
                                <input 
                                    type="password" 
                                    placeholder="أدخلي مفتاح AIzaSy..." 
                                    className="w-full bg-black border border-slate-700 rounded-xl py-3 px-4 mb-4 text-sm outline-none focus:border-indigo-500"
                                    onBlur={(e) => saveApiKey(e.target.value)}
                                />
                                <p className="text-[10px] text-slate-500">اضغطي خارج المربع أو اضغطي Enter للحفظ</p>
                            </div>
                        </div>
                    )}

                    {/* القائمة الجانبية */}
                    <div className="w-80 border-l border-white/5 p-6 flex flex-col gap-6 bg-slate-950/80">
                        <h1 className="text-xl font-black italic text-indigo-500">F-LAMBDA <span className="text-white font-light text-sm">OS</span></h1>
                        <div className="space-y-3">
                            <h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Physical Input</h2>
                            <div className="border border-slate-800 rounded-xl p-6 text-center hover:border-indigo-500 transition-all relative cursor-pointer group bg-slate-900/30">
                                <input type="file" onChange={(e) => handleFileUpload(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer" />
                                <span className="text-[10px] text-slate-400 font-bold">رفع المادة الخام</span>
                            </div>
                        </div>
                        <div className="flex-grow flex flex-col gap-3 min-h-0">
                            <h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Memory Traces</h2>
                            <div className="flex-grow overflow-y-auto custom-scrollbar space-y-2">
                                {feedbackLoop.map(trace => (
                                    <div key={trace.id} className="p-3 border-r-2 border-indigo-600 bg-white/5 rounded-l-xl">
                                        <p className="text-[9px] text-indigo-400 font-bold mb-1">{trace.parent}</p>
                                        <p className="text-[10px] text-slate-300 italic">{trace.text}</p>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <button onClick={() => setShowKeyModal(true)} className="text-[9px] text-slate-500 underline text-center">تغيير مفتاح API</button>
                    </div>

                    {/* منطقة المحادثة */}
                    <div className="flex-grow flex flex-col relative bg-slate-950">
                        <div className="flex-grow overflow-y-auto p-10 space-y-8 custom-scrollbar">
                            {messages.map(msg => (
                                <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-4 duration-500`}>
                                    <div className={`max-w-[75%] p-5 rounded-[1.8rem] text-[15px] leading-relaxed shadow-2xl ${msg.role === 'user' ? 'chat-bubble-user rounded-br-none' : 'chat-bubble-ai rounded-bl-none'}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            ))}
                            <div ref={messagesEndRef} />
                        </div>
                        <div className="p-10 bg-gradient-to-t from-black via-black/80 to-transparent">
                            <div className="max-w-4xl mx-auto relative flex items-center">
                                <input 
                                    type="text"
                                    value={chatInput}
                                    onChange={(e) => setChatInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                    placeholder="ابدئي الحوار الإدراكي..."
                                    className="w-full bg-slate-900/60 border border-slate-800 rounded-[2rem] py-5 pr-14 pl-6 text-sm outline-none focus:border-indigo-500 transition-all backdrop-blur-xl"
                                />
                                <button onClick={handleSendMessage} className="absolute left-4 p-3 bg-indigo-600 rounded-2xl hover:bg-indigo-500 transition-all">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
