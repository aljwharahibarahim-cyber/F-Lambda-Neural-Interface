<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F-Lambda Neural OS | نظام المحادثة الفيزيائي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Noto+Sans+Arabic:wght@300;600&display=swap');
        body { font-family: 'Space Grotesk', 'Noto Sans Arabic', sans-serif; background-color: #020617; color: white; margin: 0; overflow: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255,255,255,0.05); }
        .spectrum-id { font-family: monospace; color: #4ade80; }
        .chat-bubble-ai { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(99, 102, 241, 0.2); }
        .chat-bubble-user { background: #4f46e5; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e1b4b; border-radius: 10px; }
        @keyframes pulse-slow { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .pulse-status { animation: pulse-slow 2s infinite; }
        .physics-glow { box-shadow: 0 0 20px rgba(99, 102, 241, 0.1); }
    </style>
</head>
<body class="h-screen text-right">
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [spectrumID, setSpectrumID] = useState(null);
            const [partialData, setPartialData] = useState(null);
            const [messages, setMessages] = useState([
                { id: 1, role: 'ai', text: 'نظام F-Lambda نشط وجاهز. أنا ذكاؤك الفيزيائي المحلي، مرتبط بالمعالج الحتمي عبر الثابت 15.0725. كيف يمكنني خدمتك؟' }
            ]);
            const [chatInput, setChatInput] = useState('');
            const [status, setStatus] = useState("IDLE");
            const [feedbackLoop, setFeedbackLoop] = useState([]);
            
            const messagesEndRef = useRef(null);
            const F_CONSTANT = 15.0725;
            // استخدام المفتاح الذي زودتني به
            const apiKey = "AIzaSyCKGRoOco8_cTl4jiWEWl3zGdlMGiCCE5g"; 

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            // المعالج الفيزيائي وطبقة التفسير (الجسر الذكي)
            const handleFileUpload = async (file) => {
                setStatus("PROCESSING");
                // توليد الهوية الرياضية بناءً على الثابت
                const id = `SPEC-${Math.random().toString(16).slice(2, 8).toUpperCase()}-${F_CONSTANT}`;
                setSpectrumID(id);
                
                // إنشاء الإسقاط الجزئي (طبقة التفسير)
                const projection = {
                    name: file.name,
                    type: file.type,
                    size: `${(file.size / 1024).toFixed(2)} KB`,
                    timestamp: new Date().toLocaleTimeString('ar-SA')
                };
                setPartialData(projection);

                setMessages(prev => [...prev, { 
                    id: Date.now(), 
                    role: 'ai', 
                    text: `تم استقبال المادة: ${file.name}. \nالهوية الفيزيائية المولدة: ${id}. \nالنظام الآن يمتلك أثراً إدراكياً للملف.` 
                }]);
                
                setFeedbackLoop(prev => [{id: Date.now(), text: `معالجة فيزيائية: ${file.name}`, parent: id}, ...prev]);
                setStatus("IDLE");
            };

            // منطق القرار والمحادثة (الذكاء المحلي)
            const handleSendMessage = async () => {
                if (!chatInput.trim()) return;

                const userMsg = { id: Date.now(), role: 'user', text: chatInput };
                setMessages(prev => [...prev, userMsg]);
                setChatInput('');
                setStatus("COGNITION");

                try {
                    // بناء السياق الفيزيائي للذكاء الاصطناعي
                    const context = spectrumID 
                        ? `سياق المادة الحالية: الهوية ${spectrumID}, النوع ${partialData.type}, الحجم ${partialData.size}.` 
                        : "لا توجد مادة فيزيائية نشطة حالياً، تحدث بشكل عام عن نظام F-Lambda.";

                    const prompt = `أنت واجهة إدراك ذكية لنظام F-Lambda. 
                    قوانينك: الثابت الفيزيائي ${F_CONSTANT}. 
                    مهمتك: العمل كمفسر لغوي ومحلل سياق.
                    ${context}
                    المستخدم يقول: ${chatInput}
                    رد بأسلوب علمي، ذكي، ولبق باللغة العربية.`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.7, maxOutputTokens: 800 }
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error.message);

                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "اعتذار: تداخل في الموجات الإدراكية.";
                    
                    setMessages(prev => [...prev, { id: Date.now() + 1, role: 'ai', text: aiText }]);
                } catch (err) {
                    setMessages(prev => [...prev, { id: Date.now() + 1, role: 'ai', text: "تنبيه: طبقة الإدراك غير مستقرة. تأكد من إعدادات الاتصال." }]);
                    console.error("AI Error:", err);
                } finally {
                    setStatus("IDLE");
                }
            };

            return (
                <div className="flex h-full w-full bg-black overflow-hidden">
                    {/* الجانب الأيمن: لوحة التحكم الفيزيائية وذاكرة النظام */}
                    <div className="w-80 border-l border-white/5 p-6 flex flex-col gap-6 bg-slate-950/80 physics-engine">
                        <div>
                            <h1 className="text-2xl font-black italic text-indigo-500 tracking-tighter">F-LAMBDA <span className="text-white font-light text-sm">NEURAL OS</span></h1>
                            <p className="text-[9px] tracking-[0.3em] text-slate-500 font-bold uppercase mt-1">Sovereign Architecture v4.5</p>
                        </div>

                        {/* محطة الإدخال الفيزيائي */}
                        <div className="space-y-3">
                            <h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest flex items-center gap-2">
                                <span className="w-1.5 h-1.5 bg-indigo-500 rounded-full"></span>
                                Physical Input
                            </h2>
                            <div className="border border-slate-800 rounded-2xl p-6 text-center hover:border-indigo-500 transition-all relative cursor-pointer group bg-slate-900/30">
                                <input type="file" onChange={(e) => handleFileUpload(e.target.files[0])} className="absolute inset-0 opacity-0 cursor-pointer" />
                                <div className="text-indigo-500 mb-2">
                                    <svg className="w-6 h-6 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                                </div>
                                <span className="text-[10px] text-slate-400 font-bold">رفع المادة الخام</span>
                            </div>
                        </div>

                        {/* الهوية الفيزيائية الحالية */}
                        <div className="space-y-3">
                            <h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Spectrum ID</h2>
                            <div className="bg-black/50 p-4 rounded-xl border border-white/5 font-mono text-[10px] text-emerald-400 break-all leading-relaxed">
                                {spectrumID || "WAITING_FOR_SIGNAL..."}
                            </div>
                        </div>

                        {/* حلقة التغذية الراجعة (آثار الذاكرة) */}
                        <div className="flex-grow flex flex-col gap-3 min-h-0">
                            <h2 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Memory Traces</h2>
                            <div className="flex-grow overflow-y-auto custom-scrollbar space-y-2 pr-1">
                                {feedbackLoop.map(trace => (
                                    <div key={trace.id} className="p-3 border-r-2 border-indigo-600 bg-white/5 rounded-l-xl transition-all hover:bg-white/10">
                                        <p className="text-[9px] text-indigo-400 font-bold mb-1 underline">{trace.parent}</p>
                                        <p className="text-[10px] text-slate-300 leading-tight italic">{trace.text}</p>
                                    </div>
                                ))}
                                {feedbackLoop.length === 0 && (
                                    <div className="text-[10px] text-slate-700 italic text-center mt-10">لا توجد آثار ذاكرة نشطة</div>
                                )}
                            </div>
                        </div>

                        {/* مؤشر الحالة التشغيلية */}
                        <div className="p-4 bg-indigo-500/5 border border-indigo-500/10 rounded-2xl flex items-center justify-between">
                            <span className="text-[10px] font-black uppercase text-slate-500">System Status</span>
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] font-bold text-white tracking-tighter">{status}</span>
                                <div className={`w-2 h-2 rounded-full ${status !== "IDLE" ? "bg-emerald-500 pulse-status" : "bg-slate-700"}`}></div>
                            </div>
                        </div>
                    </div>

                    {/* الجانب الأيسر: قناة المحادثة والإدراك العصبوني */}
                    <div className="flex-grow flex flex-col relative bg-slate-950">
                        {/* الشعار العائم في الخلفية */}
                        <div className="absolute inset-0 opacity-[0.03] pointer-events-none flex items-center justify-center font-black text-[20vw] select-none">Fλ</div>
                        
                        {/* منطقة تدفق الرسائل */}
                        <div className="flex-grow overflow-y-auto p-10 space-y-8 custom-scrollbar">
                            {messages.map(msg => (
                                <div key={msg.id} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-4 duration-500`}>
                                    <div className={`max-w-[75%] p-5 rounded-[1.8rem] text-[15px] leading-relaxed shadow-2xl ${msg.role === 'user' ? 'chat-bubble-user rounded-br-none' : 'chat-bubble-ai rounded-bl-none'}`}>
                                        {msg.text}
                                    </div>
                                </div>
                            ))}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* منطقة التحكم والمدخلات النصية */}
                        <div className="p-10 bg-gradient-to-t from-black via-black/80 to-transparent">
                            <div className="max-w-4xl mx-auto relative">
                                <input 
                                    type="text"
                                    value={chatInput}
                                    onChange={(e) => setChatInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSendMessage()}
                                    placeholder="ابدئي الحوار الإدراكي مع النظام..."
                                    className="w-full bg-slate-900/60 border border-slate-800 rounded-[2rem] py-5 pr-14 pl-6 text-sm outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 transition-all backdrop-blur-xl"
                                />
                                <button 
                                    onClick={handleSendMessage}
                                    disabled={status !== "IDLE" || !chatInput.trim()}
                                    className="absolute left-4 top-1/2 -translate-y-1/2 p-3 bg-indigo-600 rounded-2xl hover:bg-indigo-500 transition-all disabled:opacity-20 shadow-lg shadow-indigo-600/30"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                                </button>
                            </div>
                            <div className="text-center mt-4">
                                <span className="text-[9px] text-slate-600 font-bold uppercase tracking-[0.5em]">Physical Intelligence Neural Interface v4.5</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
